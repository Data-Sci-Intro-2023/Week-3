---
title: "Lesson 3.3: USGS Streamflow"
author: "Katie Willi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Lesson Objectives:

In this lesson you will take all of the skills you have learned up to this point and use them on a completely new set of data. The USGS `dataRetrieval` package is a USGS-managed set of functions that, much like our functions from Lesson 3.1, pull data from the USGS's data warehouse using an API. Here we will pull data from a few nearby water monitoring locations in the Big Thompson and Poudre River watersheds.

This lesson has five exercises that need to be completed. 

```{r}
# pulls USGS daily ('dv') stream flow data:
q <- dataRetrieval::readNWISdv(siteNumbers = '06752260', # USGS site code for Poudre @ Lincoln Bridge
                               parameterCd = '00060', # USGS code for discharge
                               startDate = '2020-10-01', # YYYY-MM-DD formatting
                               endDate = '2022-09-30') %>% # YYYY-MM-DD formatting
  rename(q_cfs = X_00060_00003, # USGS code for cfs as discharge units
         q_cd = X_00060_00003_cd) # USGS quality control codes
```

# Exercise #1

Turn the above code base into a single function to pull in data from any USGS location, for any time frame.

```{r}
q_data <- function(site_no, site_name, start_date, end_date){
  
q <- dataRetrieval::readNWISdv(siteNumbers = site_no, # USGS site code
                               parameterCd = '00060', # USGS code for discharge
                               startDate = start_date, # YYYY-MM-DD formatting
                               endDate = end_date) %>% # YYYY-MM-DD formatting
  rename(q_cfs = X_00060_00003, 
         q_cd = X_00060_00003_cd)

return(q)

}

test <- q_data(site_no = '06752260', start_date = '2020-10-01', end_date = '2022-09-30')
```

# Exercise #2

Iterate over the function you created in Exercise 1 to pull data for the following sites:

Big Thompson Watershed:

**402114105350101**: BIG THOMPSON BL MORAINE PARK NR ESTES PARK, CO (39.8 km^2^)

**06741510**: BIG THOMPSON RIVER AT LOVELAND, CO. (531 km^2^)

Poudre Watershed:

**06746095**: JOE WRIGHT CREEK ABOVE JOE WRIGHT RESERVOIR, CO (3.14 km^2^)

**06752260**: CACHE LA POUDRE RIVER AT FORT COLLINS, CO (1128 km^2^)

Pull data from 10/1/2000 to 9/30/2022

```{r}
sites <- c("402114105350101",'06741510','06746095','06752260')

map_output <- sites %>%
  map(~ q_data(site_no = .,
               start_date = '2000-10-01',
               end_date = '2022-09-30')) %>%
  bind_rows()
```

# Exercise #3

Create an interactive ggplot() of discharge (`q_cfs`) through time, with the Big Thompson Watershed sites in one pane, and the Poudre Watershed sites in the other pane. Have the two panes on top of each other, not side-by-side. HINT: check `facet_wrap()`'s arguments.

```{r}
data <- map_output %>% 
  mutate(watershed = ifelse(site_no %in% c("402114105350101","06741510"), "Big Thompson", "Poudre"))

plotly::ggplotly(ggplot(data = data) +
  geom_line(aes(x=Date, y=q_cfs, color = site_no)) +
  theme_bw() +
  facet_wrap(~watershed, ncol=1)
  )
```

# Exercise #4

For the last full water year (i.e. 10/1/2021 - 9/30/2022), create an interactive plot of the daily difference in discharge between the Cache La Poudre River at Fort Collins and the Big Thompson River at Loveland. Make the plot's axes easy to understand.

```{r}
new_data <- data %>%
  filter(site_no %in% c("06741510","06752260")) %>%
  filter(Date >= "2021-10-01" & Date <= "2022-09-30") %>%
  select(site_no, Date, q_cfs) %>%
  pivot_wider(., names_from = site_no, values_from = q_cfs, names_prefix = "site_") %>%
  mutate(dif = (site_06741510-site_06752260)) 
  
plotly::ggplotly(ggplot(data = new_data) +
  geom_line(aes(x=Date, y=dif)) +
  theme_bw() +
  ylab("BigT Q - Poudre Q")
  )
```

# Exercise #5

How many days did the Big Thompson River have more flow than the Poudre River? 

```{r}
new_data %>% filter(dif>0) %>%
  summarize(count=n())
```
